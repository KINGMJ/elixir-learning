# 3. 创建Schema

## 创建Schema

Schema是数据库数据在Elixir中的表现形式。

在`lib/friends`中新建一个`person.ex`文件

```
defmodule Friends.Person do
  use Ecto.Schema

  schema "people" do
    field :first_name, :string
    field :last_name, :string
    field :age, :integer
  end
end
```

运行`iex -S mix`然后执行以下代码

```
iex> person = %Friends.Person{}

%Friends.Person{
  __meta__: #Ecto.Schema.Metadata<:built, "people">,
  age: nil,
  first_name: nil,
  id: nil,
  last_name: nil
}
```

得到一个`Friends.Person`的结构，可以像其他任何结构一样，对它进行一些操作

```
person = %Friends.Person{age: 28}
person = %{person | age: 28}
person.age # => 28
```

## 插入数据

```
person = %Friends.Person{}
Friends.Repo.insert(person)
```

插入成功会返回一个元组

```
{:ok, person} = Friends.Repo.insert person
```

## 验证变更

在数据库操作变更前可以进行验证，使用[changeset](https://hexdocs.pm/ecto/Ecto.Changeset.html)

在`lib/friends/person.ex`中新建一个`changeset`函数

```
def changeset(person, params \\ %{}) do
  person
  |> Ecto.Changeset.cast(params, [:first_name, :last_name, :age])
  |> Ecto.Changeset.validate_required([:first_name, :last_name])
end
```

`cast`表示要传递哪些数据，列表中未被包含的数据都会被忽略

使用`changeset`插入数据

```
person = %Friends.Person{}
changeset = Friends.Person.changeset(person, %{})
Friends.Repo.insert(changeset)
```

返回的错误格式

```
iex> {:error, changeset} = Friends.Repo.insert(changeset) 
{:error,
 #Ecto.Changeset<
   action: :insert,
   changes: %{},
   errors: [
     first_name: {"can't be blank", [validation: :required]},
     last_name: {"can't be blank", [validation: :required]}
   ],
   data: #Friends.Person<>,
   valid?: false
 >}

```

可以通过`changeset.errors`来获取错误信息，在插入前可以通过`valid?`来询问变更集本身是否有效

由于`Friends.Repo.insert`返回一个元组，我们可以使用`case`来根据不同的情况确定代码路径

```
case Friends.Repo.insert(changeset) do
  {:ok, person} ->
    # do something with person
  {:error, changeset} ->
    # do something with changeset
end
```

> `changeset.valid?`不会检查约束，例如`uniqueness_constraint`。为此，您需要尝试进行插入并检查数据库中的错误。因此最佳实践是使用`Friends.Repo.insert`尝试插入数据并根据返回的元组来验证错误